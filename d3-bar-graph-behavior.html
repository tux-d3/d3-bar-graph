<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../expandjs/expandjs.html">
<link rel="import" href="../tux-d3/tux-d3.html">
<link rel="import" href="../d3-data-consumer-behavior/d3-data-consumer-behavior.html">
<script>
  /* @polymerBehavior Tux.d3BarGraph */

  TuxD3.BarGraphBehaviorImpl =  {
      properties: {
          barHeight: {
              type: Number,
              value: 20,
              notify: true,
          },
          width: {
              type: Number,
              value: 0,
              notify: true
          },
          dataSet: {
              type: String,
              value: 'set',
              notify: true
          }
      },


      observers: [ '_handleDataSetChange(dataSet)', '_refresh(barHeight, data.*, width)' ],


      _computeWidth: function() {
          var self = this;
          var vp = self.parentNode.getViewPort();
          return self.width ? self.width: vp.getBoundingClientRect().width;
      },

      _computeHeight: function() {
          var self = this;
          var vp = self.parentNode.getViewPort();
          return self.height ? self.height: vp.getBoundingClientRect().height;
      },

      attached: function() {
          var self = this;
          self.async(function() {
              self.parentNode.addResizeListener(self);
              self._refresh();
          });
      },

      _refresh: function(barHeight, data, width) {
          var self = this;
          if(self.isAttached) {
              self._draw();
          }
      },

      _handleDataSetChange: function(dataSet) {
          var self = this;
          if(self.isAttached) {
              self._draw(true);
          }
      },


      _draw: function(clear) {
          var self = this;
          var chart = d3.select(self.parentNode.getViewPort());
          var wrapper = chart.select("g.d3-bar-graph-wrapper");

          var transition = d3.transition();

          if(wrapper.empty()) {
              chart.append("g")
              .classed("d3-bar-graph-wrapper", true)
              .attr('width', self._computeWidth())
              .attr('height', self._computeHeight());
          }

          if(clear) {
              var groups = wrapper.selectAll('g');
              groups.selectAll('rect')
                    .transition()
                        .ease('quad-in-out')
                        .duration(750)
                        .attr('width', 0)
                        .style('opacity', 0)
                        .end(function() {
                            groups.remove();
                            __do_draw();
                        })
                    ;
          }
          else {
              transition.transition().end(__do_draw);
          }

          function __do_draw() {
              var x = d3.scale.linear()
                  .domain([0, d3.max(self.data[self.dataSet], function(d) { return XP.isObject(d) ? d.value : d; })])
                  .range([0, self._computeWidth()]);

              var groups = wrapper
                  .selectAll("g")
                  .data(self.data[self.dataSet]);

              var bar = groups.enter().append("g");

              bar.append("rect");
              bar.append("text");

              var bars = wrapper.selectAll('g');
              bars.attr("transform", function(d, i) { return "translate(0," + i * self.barHeight + ")"; });
              bars.selectAll('rect')
                  .attr('width', 0)
                  .attr("height", self.barHeight - 1)
                  .style('opacity', 0)
                  .transition()
                        .duration(750)
                        .ease('quad-in-out')
                        .attr('width', function(d) { return x(XP.isObject(d) ? d.value : d); })
                        .style('opacity', 1)
                        ;

              bars.selectAll('text')
                  .attr("y", self.barHeight / 2)
                  .attr("dy", ".35em")
                  .text(function(d) { return XP.isObject(d) ? d.label + '[' + d.value + ']': d; })
                  .attr("x", function(d) { return x(XP.isObject(d)? d.value : d) - 10; });
          }

      }
  };

  /* @polymerBehavior */
  TuxD3.BarGraphBehavior = [ TuxD3.DataConsumerBehavior, TuxD3.BarGraphBehaviorImpl ];
</script>
