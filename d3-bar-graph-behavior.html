<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../expandjs/expandjs.html">
<link rel="import" href="../tux-d3/tux-d3.html">
<link rel="import" href="../d3-data-consumer-behavior/d3-data-consumer-behavior.html">
<script>
  /* @polymerBehavior Tux.d3BarGraph */

  TuxD3.BarGraphBehaviorImpl =  {
      properties: {
          barHeight: {
              type: Number,
              value: 20,
              notify: true,
          },
          width: {
              type: Number,
              value: 0,
              notify: true
          }
      },

      listeners: {
          'resize': '_handleResize'
      },

      observers: [ '_refresh(barHeight, data.splice, width)' ],

      _handleResize: function(event) {
            var self = this;
            var firer = event.detail.firer;
            if(firer === self.parentNode) {
                self._refresh();
            }
      },

      _computeWidth: function() {
          var self = this;
          var vp = self.parentNode.getViewPort();
          return self.width ? self.width: vp.getBoundingClientRect().width;
      },

      attached: function() {
          var self = this;
          self.async(function() {
              self.parentNode.addResizeListener(self);
          });
      },

      _refresh: function(barHeight, data, width) {
          var self = this;
          self._draw();
      },

      _draw: function() {
          var self = this;
          var chart = d3.select(self.parentNode.getViewPort());
          var groups = chart.selectAll("g")
              .data(self.data, function(d, i) { return i; });

          var bar = groups.enter().append("g");

          bar.append("rect");
          bar.append("text");


          var x = d3.scale.linear()
                  .domain([0, d3.max(self.data)])
                  .range([0, self._computeWidth()]);


          var bars = chart.selectAll('g');
          bars.attr("transform", function(d, i) { return "translate(0," + i * self.barHeight + ")"; });
          bars.selectAll('rect')
              .attr('width', function(d) { return x(d); })
              .attr("height", self.barHeight - 1);

          bars.selectAll('text')
              .attr("x", function(d) { return x(d) - 3; })
              .attr("y", self.barHeight / 2)
              .attr("dy", ".35em")
              .text(function(d) { return d; });

          groups.exit().remove();

      }
  };

  /* @polymerBehavior */
  TuxD3.BarGraphBehavior = [ TuxD3.DataConsumerBehavior, TuxD3.BarGraphBehaviorImpl ];
</script>
